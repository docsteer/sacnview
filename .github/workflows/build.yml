# Github Actions configuration file
# Runs the build on Linux, Windows and MacOS
name: Build

on:
  push:
  pull_request:
  page_build:
  release:
    types:
      - created
      - edited
      - prereleased
      - released

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        # https://github.com/actions/virtual-environments#available-environments
        os: [ubuntu-18.04, windows-latest, macos-latest]
        include:
          - os: ubuntu-18.04 # Oldest LTS for appimage support
            qt: '5.15.2' # Oldest LTS for appimage support 
            qt_modules: ''
            dependencies: |
              sudo apt-get install mesa-common-dev libgl1-mesa-dev libpcap-dev libgstreamer-gl1.0-0 libgstreamer-plugins-base1.0-0 -y
            # public_suffix v4.0.7 only requied for legacy ubuntu-18.04
            installer_setup: |
              sudo gem install public_suffix -v 4.0.7
              sudo gem install --no-document fpm
            make_cmd: make
            artifact: |
              sACNView*.AppImage
              install/linux/*.deb

          - os: windows-latest
            qt: '6.2.4'
            qt_modules: 'qtmultimedia'
            installer_setup: |
              Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/e/e0/NSIS_Simple_Firewall_Plugin_Unicode_1.21.zip" -OutFile "NSIS_Simple_Firewall_Plugin_Unicode.zip"
              7z e NSIS_Simple_Firewall_Plugin_Unicode.zip -o"C:\Program Files (x86)\NSIS\Plugins\x86-unicode"
            arch: win32_msvc2019
            make_cmd: nmake
            artifact: |
              install/win/sACNView*.exe
              release/*.pdb 

          - os: macos-latest
            qt: '6.2.4'
            qt_modules: 'qtmultimedia'
            installer_setup: |
              brew install create-dmg
            xcode: latest-stable
            make_cmd: make
            artifact: install/mac/sACNView*.dmg 

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install Qt
      uses: jurplel/install-qt-action@v2.14.0
      with:
        version: ${{ matrix.qt }}
        modules: ${{ matrix.qt_modules }}
        aqtversion: '==2.0.0'

    - name: Dependencies
      run: ${{ matrix.dependencies }} 

    - name: Setup Installer
      run: ${{ matrix.installer_setup }}

    - name: Environment Setup (MSVC)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Environment Setup (Xcode)
      if: runner.os == 'macOS'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode }}

    - name: Run qmake
      shell: bash
      run: |
        if [[ -n "${Qt5_DIR}" ]]; then export QTDIR=${Qt5_DIR}; fi
        if [[ -n "${Qt6_DIR}" ]]; then export QTDIR=${Qt6_DIR}; fi
        qmake sACNView.pro

    - name: Run make
      run: ${{ matrix.make_cmd }}

    - name: Upload Artifact(s)
      uses: actions/upload-artifact@v2
      with:
        name: ${{ runner.os }}
        path: ${{ matrix.artifact }} 