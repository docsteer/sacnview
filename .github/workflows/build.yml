# Github Actions configuration file
# Runs the Windows
# TODO: After update, add back Mac and Linux
name: Build

on:
  push:
  pull_request:
  page_build:
  release:
    types:
      - created
      - edited
      - prereleased
      - released

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        # https://github.com/actions/virtual-environments#available-environments
        os: [windows-latest]
        include:
          - os: windows-latest
            qt: '6.8.2'
            qt_modules: 'qtmultimedia'
            installer_setup: |
              Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/e/e0/NSIS_Simple_Firewall_Plugin_Unicode_1.21.zip" -OutFile "NSIS_Simple_Firewall_Plugin_Unicode.zip"
              7z e NSIS_Simple_Firewall_Plugin_Unicode.zip -o"C:\Program Files (x86)\NSIS\Plugins\x86-unicode"
            artifact: |
              ./install/win64/sACNView64*.exe
              ./out/build/windows-x64-release-installer/sACNView.pdb

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ matrix.qt }}
        modules: ${{ matrix.qt_modules }}

    - name: Dependencies
      run: ${{ matrix.dependencies }}

    - name: Setup Installer
      run: ${{ matrix.installer_setup }}

    - name: Environment Setup (MSVC)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: CMake Configure
      shell: bash
      run: |
        if [[ -n "${Qt6_DIR}" ]]; then export QTROOT=${Qt6_DIR}; fi
        cmake --preset "windows-x64-release-installer"

    - name: CMake Build
      run: cmake --build --preset "windows-x64-release-installer"

    - name: Upload Artifact(s)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ runner.os }}
        path: ${{ matrix.artifact }}
